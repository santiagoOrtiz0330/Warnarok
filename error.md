What we’re solving

You have two externally exposed services whose public (NAT) ports differ from the internal listen ports:

Service 2 (Char Server): public 55237 → container listens on 6121

Service 3 (Map Server): public 12246 → container listens on 5121

Today, the char server tells the login server its listen port (e.g., 6121). That fails for clients connecting from outside the container/host, because they must reach 55237.

We introduce advertise_port (and optionally advertise_host) so the server listens on char_port internally but advertises advertise_port (and host) to peers/clients.

High-level design

Config surface

Add advertise_port (and strongly recommended: advertise_host) to:

Char server config (e.g., char.conf / char_athena.conf)

Map server config (e.g., map.conf / map_athena.conf)

Defaults:

advertise_port defaults to the internal *_port if unset.

advertise_host defaults to the existing *_ip or server_name if unset.

Runtime behavior

Listen on internal *_port as before (e.g., 6121/5121).

When registering with upstream (char→login, map→char), send advertise_host + advertise_port, not the listen port.

Anywhere the server crafts endpoint info for clients (e.g., char replies to login with where clients should connect), use the advertise values.

Backward compatibility

If advertise_port isn’t set, behavior is unchanged (keeps sending *_port).

Where to change the code (typical server layout)

Names will vary by codebase, but these are the common touchpoints in RO-style tri-server architectures.

Char server

Config parsing (e.g., src/char/char.c or src/common/conf.c reading char.conf):

Add fields:

int char_port;          // existing
int advertise_port;     // new (default = char_port)
char advertise_host[...];// new (default = char_ip/server_name)


Handshake with login (e.g., chclif.c, chclif_send_register(), or similar “register/hello” function):

Replace payload field that currently sends char_port with advertise_port.

Replace host/IP field with advertise_host when present.

Any client-facing redirection generated by char (e.g., when login asks char “what should clients connect to?”):

Use advertise values.

Map server

Config parsing (e.g., src/map/map.c or shared config reader):

Add map_port (existing), advertise_port (new), advertise_host (new; same defaults).

Handshake with char (e.g., mapclif.c or inter.c):

Use advertise_* values when the map server reports itself to the char server or when char forwards endpoints to clients.

Login server

Receiving side (e.g., src/login/login.c or loginif.c):

No config change required. Just consume whatever port/host the char server reports. (No validation change needed if you already trust the sender.)

Minimal config examples
char.conf
// Internal listen address/port inside container
char_ip: 0.0.0.0
char_port: 6121

// What other services/clients should use to reach char from outside
advertise_host: example.com      // or your public IP
advertise_port: 55237

map.conf
map_ip: 0.0.0.0
map_port: 5121

advertise_host: example.com
advertise_port: 12246


If advertise_* is omitted, the server falls back to *_ip/*_port.

Docker wiring
docker-compose.yml (relevant parts)
services:
  login:
    image: your/login
    ports:
      - "6900:6900"   # example

  char:
    image: your/char
    ports:
      - "55237:6121"  # host:container
    environment:
      - CHAR_PORT=6121
      - CHAR_ADVERTISE_HOST=example.com
      - CHAR_ADVERTISE_PORT=55237

  map:
    image: your/map
    ports:
      - "12246:5121"
    environment:
      - MAP_PORT=5121
      - MAP_ADVERTISE_HOST=example.com
      - MAP_ADVERTISE_PORT=12246

docker-entrypoint.sh (read env → inject config)
#!/usr/bin/env bash
set -e

# Defaults if not provided
: "${CHAR_PORT:=6121}"
: "${CHAR_ADVERTISE_PORT:=${CHAR_PORT}}"
: "${CHAR_ADVERTISE_HOST:=${PUBLIC_HOSTNAME:-}}"

: "${MAP_PORT:=5121}"
: "${MAP_ADVERTISE_PORT:=${MAP_PORT}}"
: "${MAP_ADVERTISE_HOST:=${PUBLIC_HOSTNAME:-}}"

# Patch char.conf
sed -ri "s|^char_port:.*$|char_port: ${CHAR_PORT}|" /app/conf/char.conf
if grep -q '^advertise_port:' /app/conf/char.conf; then
  sed -ri "s|^advertise_port:.*$|advertise_port: ${CHAR_ADVERTISE_PORT}|" /app/conf/char.conf
else
  echo "advertise_port: ${CHAR_ADVERTISE_PORT}" >> /app/conf/char.conf
fi
if [ -n "${CHAR_ADVERTISE_HOST}" ]; then
  if grep -q '^advertise_host:' /app/conf/char.conf; then
    sed -ri "s|^advertise_host:.*$|advertise_host: ${CHAR_ADVERTISE_HOST}|" /app/conf/char.conf
  else
    echo "advertise_host: ${CHAR_ADVERTISE_HOST}" >> /app/conf/char.conf
  fi
fi

# Patch map.conf
sed -ri "s|^map_port:.*$|map_port: ${MAP_PORT}|" /app/conf/map.conf
if grep -q '^advertise_port:' /app/conf/map.conf; then
  sed -ri "s|^advertise_port:.*$|advertise_port: ${MAP_ADVERTISE_PORT}|" /app/conf/map.conf
else
  echo "advertise_port: ${MAP_ADVERTISE_PORT}" >> /app/conf/map.conf
fi
if [ -n "${MAP_ADVERTISE_HOST}" ]; then
  if grep -q '^advertise_host:' /app/conf/map.conf; then
    sed -ri "s|^advertise_host:.*$|advertise_host: ${MAP_ADVERTISE_HOST}|" /app/conf/map.conf
  else
    echo "advertise_host: ${MAP_ADVERTISE_HOST}" >> /app/conf/map.conf
  fi
fi

exec "$@"

Code changes (illustrative C diffs)
1) Config structure
// char_server_config.h
typedef struct {
    char ip[64];
    int  port;
    char advertise_host[64]; // new
    int  advertise_port;     // new
} char_server_config_t;

2) Parse with sane defaults
// on config load
cfg->advertise_port = get_int("advertise_port", cfg->port);
get_str("advertise_host", cfg->advertise_host, sizeof(cfg->advertise_host), NULL);
if (!cfg->advertise_host[0]) {
    strlcpy(cfg->advertise_host, cfg->ip, sizeof(cfg->advertise_host));
}

3) Use advertise values in registration packet
// chclif_send_register()
packet.host = cfg->advertise_host; // previously: cfg->ip or derived
packet.port = cfg->advertise_port; // previously: cfg->port (listen)
send_to_login(&packet);


Do the analogous change in the map server’s registration to the char server.

Testing checklist

Local health

Containers start; char listens on 6121; map listens on 5121.

Inter-server registration

Login logs show char registered at advertise_host:advertise_port (e.g., example.com:55237).

Char logs show map registered at example.com:12246 (if map advertises).

External client connectivity

Client receives 55237 for char and 12246 for map (via whatever discovery/handshake path your code uses).

No-advertise fallback

Remove advertise_* from configs; ensure legacy behavior still works on a flat network.

Bad env guardrails

If advertise_port is set to an in-use port, startup should fail fast with a clear log, or at minimum warn.

Commit message (suggested)
feat(networking): add advertise_host/advertise_port to char/map servers

- Allow separation of listen vs. advertised endpoints for NAT/Docker.
- char/map now send advertise_* to their upstream peers during registration.
- Defaults to existing *_ip/*_port to retain backward compatibility.
- Updated entrypoint to inject from env into configs.

Rollout notes

Apply the change to char first, then map. Login server typically needs no change.

Restart services with the new configs and verify peer registrations show public ports (55237 / 12246).

If you have multiple environments, set advertise_* via env and keep the same container image.